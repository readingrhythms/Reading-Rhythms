---
import BaseLayout from '@layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import arrowright from '@assets/icons/arrow-right.svg';

// =====================================================
// FEATURE FLAGS - Toggle these when pasting to live
// =====================================================
const ENABLE_VIRTUAL_TAB = false;
const ENABLE_PASSPORT_PROMO = false;
// =====================================================

// Active chapters with Luma calendar embeds - 4 main regions
const baseChapters = [
  {
    id: 'ny',
    name: 'NY',
    fullName: 'Reading Rhythms New York',
    location: 'New York State',
    calendarId: 'cal-Q8l315UsVMWb6h6',
    description: 'Events across New York State',
    status: 'active',
    isNew: false
  },
  {
    id: 'nj',
    name: 'NJ',
    fullName: 'Reading Rhythms New Jersey',
    location: 'New Jersey',
    calendarId: 'cal-4yEtAsPtiPI0Nwi',
    description: 'Events across New Jersey',
    status: 'active',
    isNew: false
  },
  {
    id: 'ca',
    name: 'CA',
    fullName: 'Reading Rhythms California',
    location: 'California',
    calendarId: 'cal-Eo35suMbTdQnr20',
    description: 'Events across California',
    status: 'active',
    isNew: false
  },
  {
    id: 'global',
    name: 'Global',
    fullName: 'Reading Rhythms Global',
    location: 'Special Events Worldwide',
    calendarId: 'cal-CDoX2WaI5IHD5xs',
    description: 'Exclusive global events and virtual sessions',
    status: 'active',
    isNew: false
  }
];

const virtualChapter = {
  id: 'virtual',
  name: 'Virtual',
  fullName: 'Reading Rhythms Virtual',
  location: 'Online Events',
  calendarId: 'cal-lPEjhFiZCQl0esb',
  description: 'Join from anywhere - virtual reading sessions',
  status: 'active',
  isNew: true
};

const activeChapters = ENABLE_VIRTUAL_TAB
  ? [...baseChapters, virtualChapter]
  : baseChapters;
---

<BaseLayout title='Reading Rhythms | Events & Tickets' description='Buy tickets for Reading Rhythms events worldwide. Join active chapters or waitlists for launching cities.' showNavbar={true}>
  <!-- Main Content - Direct to Tickets -->
  <div class="w-full px-0 pt-2 lg:pt-4">
    <!-- Single Header -->
    <div class="text-center mb-4 md:mb-6 max-w-4xl mx-auto px-4">
      <h1 class="text-3xl md:text-4xl lg:text-5xl text-dark-gray font-display tracking-wider leading-tight mb-3 md:mb-4">
        Find Your Next <span class="bg-gradient-to-r from-jean via-rust to-dark-purple bg-clip-text text-transparent">Reading Party</span>
      </h1>
      <p class="text-base md:text-lg text-dark-gray/60 font-light max-w-2xl mx-auto">
        Buy tickets for upcoming events
      </p>
    </div>

    <!-- Mobile-First Tab Navigation - Horizontal Scroll -->
    <div class="flex justify-center mb-3 md:mb-4 px-4">
      <div class="tab-scroll-container relative">
        <div class="bg-gray-100/80 backdrop-blur-sm rounded-2xl p-1.5 sm:p-2 overflow-x-auto scrollbar-hide inline-flex border border-gray-200/50">
          <div class="flex gap-1 items-center" role="tablist" aria-label="Chapters">
            {activeChapters.map((chapter, index) => (
              <>
                {chapter.isNew && index > 0 && (
                  <div class="w-px h-6 bg-dark-gray/20 mx-1 flex-shrink-0"></div>
                )}
                <button
                  class={`tab-button flex-shrink-0 px-3 sm:px-5 lg:px-7 py-2 sm:py-2.5 lg:py-3 rounded-xl font-semibold text-sm sm:text-base transition-all duration-300 whitespace-nowrap ${
                    index === 0
                      ? 'bg-white text-dark-gray shadow-md'
                      : 'text-dark-gray/60 hover:text-dark-gray hover:bg-white/50'
                  }`}
                data-tab={chapter.id}
                data-is-new={chapter.isNew ? 'true' : 'false'}
                role="tab"
                aria-selected={index === 0 ? 'true' : 'false'}
                aria-controls={`panel-${chapter.id}`}
                type="button"
              >
                <span class="flex items-center gap-1.5">
                  {chapter.name}
                  {chapter.isNew && (
                    <span class="new-dot w-1.5 h-1.5 rounded-full bg-sage animate-pulse"></span>
                  )}
                </span>
              </button>
              </>
            ))}
          </div>
        </div>
        <!-- Scroll indicator fade - mobile only -->
        <div class="scroll-fade-right absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-cream/80 to-transparent pointer-events-none rounded-r-2xl sm:hidden"></div>
      </div>
    </div>

    {ENABLE_PASSPORT_PROMO && (
      <div id="passport-promo" class="passport-promo text-center mb-2 px-2 sm:px-4" data-show-tabs="ny,virtual">
        <a
          href="/passport"
          class="passport-link group inline-flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm text-dark-gray/70 hover:text-dark-gray transition-all duration-200 py-1.5 sm:py-2 px-2 sm:px-3 rounded-lg hover:bg-sage/5"
        >
          <span class="w-1.5 h-1.5 rounded-full bg-sage group-hover:scale-125 transition-transform flex-shrink-0"></span>
          <span class="sm:hidden"><span class="passport-text font-semibold text-dark-gray">Passport</span> for unlimited access</span>
          <span class="hidden sm:inline">Get unlimited access with <span class="passport-text font-semibold text-dark-gray underline decoration-sage/40 underline-offset-2 hover:decoration-sage transition-all">Passport membership</span></span>
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 group-hover:translate-x-1 transition-transform duration-200 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    )}

    <!-- Tab Content - Nearly Full Width Luma Embeds -->
    <div class="tab-content-container mb-8 md:mb-12 px-0 mx-0 max-w-6xl md:mx-auto">
      {activeChapters.map((chapter, index) => (
        <div 
          /* IMPORTANT: no id here to avoid browser hash-jump */
          class={`tab-content ${index === 0 ? 'active' : 'hidden'}`}
          data-content={chapter.id}
          data-anchor={chapter.id}       /* we use this for our own logic only */
          role="tabpanel"
          id={`panel-${chapter.id}`}
          aria-hidden={index === 0 ? 'false' : 'true'}
          tabindex="0"
        >
          <!-- Full Width Container -->
          <div class="w-full bg-white rounded-xl shadow-xl shadow-black/5 overflow-hidden md:mx-0" style="margin-left: -8px; margin-right: -8px; width: calc(100% + 16px);">
            <!-- Minimal Padding for Maximum Calendar Space -->
            <div class="p-0">
              <!-- Maximum Width Luma Calendar -->
              <div class="w-full">
                <div class="calendar-container w-full" style="min-height: 1100px;">
                  <iframe
                    src={`https://lu.ma/embed/calendar/${chapter.calendarId}/events?lt=light`}
                    width="100%"
                    height="1100"
                    frameborder="0"
                    style="border: none; min-height: 1100px; width: 100%; max-width: 100%;"
                    allowfullscreen=""
                    aria-hidden="false"
                    tabindex="-1"
                    class=""
                    loading="lazy"
                  ></iframe>
                </div>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Host Application CTA -->
    <div class="px-4">
      <div class="bg-gradient-to-r from-dark-gray to-dark-purple rounded-2xl p-6 lg:p-10 text-center max-w-4xl mx-auto mb-8 lg:mb-12">
        <h3 class="text-2xl lg:text-3xl font-display text-white mb-3 tracking-widest">
          Want to Host in Your City?
        </h3>
        <p class="text-white/75 mb-6 max-w-xl mx-auto text-sm lg:text-base leading-relaxed">
          We're always looking for passionate community builders to bring Reading Rhythms to new cities.
        </p>
        <a
          href="/apply"
          class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-white text-dark-gray rounded-xl font-bold text-base hover:shadow-xl hover:shadow-white/25 transition-all duration-300 hover:-translate-y-1 hover:bg-cream group"
        >
          Join the Team
          <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const passportPromo = document.getElementById('passport-promo');
    const scrollContainer = document.querySelector('.scrollbar-hide');
    const scrollFade = document.querySelector('.scroll-fade-right');

    function updateScrollFade() {
      if (!scrollContainer || !scrollFade) return;
      const isAtEnd = scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 10;
      if (isAtEnd) {
        scrollFade.classList.add('hidden');
      } else {
        scrollFade.classList.remove('hidden');
      }
    }

    if (scrollContainer) {
      scrollContainer.addEventListener('scroll', updateScrollFade);
      updateScrollFade();

      if (window.innerWidth < 640 && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
        setTimeout(() => {
          scrollContainer.scrollTo({ left: 40, behavior: 'smooth' });
          setTimeout(() => {
            scrollContainer.scrollTo({ left: 0, behavior: 'smooth' });
          }, 400);
        }, 800);
      }
    }

    function updatePassportPromo(tabId) {
      if (!passportPromo) return;
      const showTabs = passportPromo.dataset.showTabs?.split(',') || [];
      if (showTabs.includes(tabId)) {
        passportPromo.classList.remove('hidden');
        passportPromo.classList.add('passport-promo-visible');
      } else {
        passportPromo.classList.add('hidden');
        passportPromo.classList.remove('passport-promo-visible');
      }
    }

    function showTab(targetId, { updateUrl = true } = {}) {
      // Hide all tab contents
      tabContents.forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
        content.setAttribute('aria-hidden', 'true');
      });

      // Remove active state from all buttons
      tabButtons.forEach(button => {
        button.classList.remove('bg-white', 'text-dark-gray', 'shadow-md');
        button.classList.add('text-dark-gray/60', 'hover:text-dark-gray', 'hover:bg-white/50');
        button.setAttribute('aria-selected', 'false');
      });

      // Show target tab content
      const targetContent = document.querySelector(`[data-content="${targetId}"]`);
      if (targetContent) {
        targetContent.classList.remove('hidden');
        targetContent.classList.add('active');
        targetContent.setAttribute('aria-hidden', 'false');
      }

      // Activate clicked button
      const activeButton = document.querySelector(`[data-tab="${targetId}"]`);
      if (activeButton) {
        activeButton.classList.add('bg-white', 'text-dark-gray', 'shadow-md');
        activeButton.classList.remove('text-dark-gray/60', 'hover:text-dark-gray', 'hover:bg-white/50');
        activeButton.setAttribute('aria-selected', 'true');
      }

      // Update passport promo visibility
      updatePassportPromo(targetId);

      // Update URL hash WITHOUT causing browser scroll (no element has that id)
      if (updateUrl) {
        history.replaceState(null, '', `${location.pathname}#${targetId}`);
      }
    }

    // Initial selection: support ?chapterId=... OR #hash
    const urlParams = new URLSearchParams(window.location.search);
    const chapterIdParam = urlParams.get('chapterId');
    const hashId = window.location.hash ? window.location.hash.slice(1) : null;

    // Choose initial tab (default to first if none provided)
    const initialId =
      chapterIdParam ||
      hashId ||
      (tabButtons[0] && tabButtons[0].getAttribute('data-tab'));

    if (initialId) {
      // Normalize to #... for sharing if query param used
      if (chapterIdParam && (!hashId || hashId !== chapterIdParam)) {
        history.replaceState(null, '', `${location.pathname}#${chapterIdParam}`);
      }
      // Render initial tab and ensure we remain at very top
      showTab(initialId, { updateUrl: false });
      window.scrollTo(0, 0);
    } else {
      // Default to first tab (ny), also update promo visibility
      updatePassportPromo('ny');
    }

    // Click -> change tab without jumping, keep top
    tabButtons.forEach(button => {
      button.addEventListener('click', (ev) => {
        ev.preventDefault();
        const tabId = button.getAttribute('data-tab');
        showTab(tabId);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    // Manual hash edits -> switch tab (no jump because no element id matches)
    window.addEventListener('hashchange', () => {
      const newId = window.location.hash.slice(1);
      if (newId) {
        showTab(newId, { updateUrl: false });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  });
</script>

<style>
  /* Hide scrollbar but keep functionality */
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }

  /* Tab scroll container */
  .tab-scroll-container {
    max-width: 100%;
  }

  /* Scroll fade indicator - hints at more content */
  .scroll-fade-right {
    opacity: 1;
    transition: opacity 0.3s ease;
  }
  .scroll-fade-right.hidden {
    opacity: 0;
  }

  /* Keep original look: remove focus ring on tabs */
  .tab-button { -webkit-tap-highlight-color: transparent; }
  .tab-button:focus,
  .tab-button:focus-visible { outline: none !important; box-shadow: none !important; }

  /* Remove blue outline on Luma iframe on mobile */
  .calendar-container iframe:focus { outline: none !important; }
  .calendar-container, .calendar-container * { -webkit-tap-highlight-color: transparent; }

  /* Tab transitions */
  .tab-content { transition: opacity 0.3s ease-in-out; }
  .tab-content.hidden { opacity: 0; display: none; }
  .tab-content.active { opacity: 1; display: block; }

  /* Full width iframe optimization */
  iframe { max-width: 100% !important; width: 100% !important; min-width: 100% !important; }

  /* Desktop centering */
  @media (min-width: 768px) {
    .tab-content-container { max-width: 1200px; }
    .tab-content > div { margin-left: 0 !important; margin-right: 0 !important; width: 100% !important; }
  }

  /* Mobile responsive adjustments - Extended height */
  @media (max-width: 640px) {
    .calendar-container { min-height: 1000px !important; }
    .calendar-container iframe { height: 1000px !important; min-height: 1000px !important; }
  }

  /* Tablet adjustments */
  @media (min-width: 641px) and (max-width: 1024px) {
    .calendar-container { min-height: 1050px !important; }
    .calendar-container iframe { height: 1050px !important; min-height: 1050px !important; }
  }

  /* Desktop - maximum height */
  @media (min-width: 1025px) {
    .calendar-container { min-height: 1100px !important; }
    .calendar-container iframe { height: 1100px !important; min-height: 1100px !important; }
  }

  /* Loading state for iframes */
  .calendar-container { position: relative; }
  .calendar-container::before {
    content: "Loading events...";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #6b7280;
    font-size: 1rem;
    z-index: 1;
  }
  .calendar-container iframe { position: relative; z-index: 2; background: white; }

  /* Passport promo styling */
  .passport-promo {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: opacity 0.3s ease, max-height 0.3s ease;
  }
  .passport-promo.hidden { display: none; }
  .passport-promo-visible {
    opacity: 1;
    max-height: 60px;
  }

  /* Passport link hover effect */
  .passport-link:hover .passport-text {
    text-decoration-color: #8B9A7F;
  }

  /* New dot pulse */
  .new-dot {
    box-shadow: 0 0 0 0 rgba(139, 154, 127, 0.4);
    animation: dot-pulse 2s ease-in-out infinite;
  }
  @keyframes dot-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(139, 154, 127, 0.4); }
    50% { box-shadow: 0 0 0 4px rgba(139, 154, 127, 0); }
  }
</style>
